% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/ds.psiAlign.R
\name{ds.psiAlign}
\alias{ds.psiAlign}
\title{ECDH-PSI Record Alignment (Blind Relay)}
\usage{
ds.psiAlign(
  data_name,
  id_col,
  newobj = "D_aligned",
  ref_server = NULL,
  datasources = NULL
)
}
\arguments{
\item{data_name}{Character string. Name of the data frame on each server.}

\item{id_col}{Character string. Name of the identifier column.}

\item{newobj}{Character string. Name for the aligned data frame on servers.
Default is \code{"D_aligned"}.}

\item{ref_server}{Character string or NULL. Name of the reference server.
If NULL (default), the first connection is used.}

\item{datasources}{DataSHIELD connection object or list of connections.
If NULL, uses all available connections.}
}
\value{
Invisibly returns a list with alignment statistics for each server:
\itemize{
\item \code{n_matched}: Number of records matched
\item \code{n_total}: Number of records on that server
}
}
\description{
Privacy-preserving record alignment using Elliptic Curve
Diffie-Hellman Private Set Intersection (ECDH-PSI) with blind-relay
transport encryption. Aligns data frames across vertically partitioned
DataSHIELD servers so that rows correspond to the same individuals.
The client never sees raw EC points — only opaque encrypted blobs.
}
\details{
This function performs privacy-preserving record alignment in a single call,
using ECDH-PSI with blind-relay transport encryption.

\subsection{Protocol overview}{
ECDH-PSI exploits the commutativity of elliptic curve scalar multiplication:
\eqn{\alpha \cdot (\beta \cdot H(id)) = \beta \cdot (\alpha \cdot H(id))}.

All EC point exchanges are encrypted server-to-server (X25519 + AES-256-GCM
ECIES). The client acts as a blind relay, seeing only opaque blobs.

\enumerate{
\item \strong{Phase 0}: Each server generates an X25519 transport keypair.
Public keys are exchanged via the client.
\item \strong{Phase 1}: The reference server masks IDs with scalar
\eqn{\alpha}. Points are stored server-side (not returned to client).
\item For each target server:
\itemize{
\item The reference encrypts masked points under the target's PK.
\item The target decrypts, generates scalar \eqn{\beta}, double-masks
ref points (stores locally), masks own IDs, encrypts them under
the ref's PK.
\item The reference decrypts, double-masks with \eqn{\alpha},
encrypts result under target's PK.
\item The target decrypts, matches double-masked sets, aligns data.
}
\item A multi-server intersection ensures only records present on ALL
servers are retained.
}
}

\subsection{Security (DDH assumption on P-256, malicious-client model)}{
\itemize{
\item The client sees only opaque encrypted blobs — not EC points.
\item Each server's scalar never leaves the server.
\item PSI firewall: phase ordering + one-shot semantics prevent OPRF
oracle attacks.
}
}
}
\examples{
\dontrun{
# Align records across all servers using PSI
ds.psiAlign("D", "patient_id", "D_aligned", datasources = connections)

# Now "D_aligned" on all servers has matching, ordered observations
}

}
\seealso{
\code{\link{ds.vertCor}}, \code{\link{ds.vertGLM}} for analysis
functions that operate on aligned data.
}
