<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Privacy-Preserving Correlation for Vertically Partitioned Data — ds.vertCor • dsVertClient</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet"><meta property="og:title" content="Privacy-Preserving Correlation for Vertically Partitioned Data — ds.vertCor"><meta name="description" content="Computes the Pearson correlation matrix for vertically partitioned
data using Multiparty Homomorphic Encryption (MHE) with threshold decryption."><meta property="og:description" content="Computes the Pearson correlation matrix for vertically partitioned
data using Multiparty Homomorphic Encryption (MHE) with threshold decryption."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">dsVertClient</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.4.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/a-getting-started.html">Getting Started with dsVertClient</a></li>
    <li><a class="dropdown-item" href="../articles/b-statistical-analysis.html">Statistical Analysis</a></li>
    <li><a class="dropdown-item" href="../articles/c-methodology.html">Methodology</a></li>
    <li><a class="dropdown-item" href="../articles/d-validation.html">Validation</a></li>
    <li><a class="dropdown-item" href="../articles/e-security.html">Security Model</a></li>
  </ul></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/isglobal-brge/dsVertClient" aria-label="GitHub"><span class="fa fa-github"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Privacy-Preserving Correlation for Vertically Partitioned Data</h1>
      <small class="dont-index">Source: <a href="https://github.com/isglobal-brge/dsVertClient/blob/HEAD/R/ds.vertCor.R" class="external-link"><code>R/ds.vertCor.R</code></a></small>
      <div class="d-none name"><code>ds.vertCor.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Computes the Pearson correlation matrix for vertically partitioned
data using Multiparty Homomorphic Encryption (MHE) with threshold decryption.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">ds.vertCor</span><span class="op">(</span></span>
<span>  <span class="va">data_name</span>,</span>
<span>  <span class="va">variables</span>,</span>
<span>  log_n <span class="op">=</span> <span class="fl">12</span>,</span>
<span>  log_scale <span class="op">=</span> <span class="fl">40</span>,</span>
<span>  datasources <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-data-name">data_name<a class="anchor" aria-label="anchor" href="#arg-data-name"></a></dt>
<dd><p>Character string. Name of the (aligned) data frame on
each server.</p></dd>


<dt id="arg-variables">variables<a class="anchor" aria-label="anchor" href="#arg-variables"></a></dt>
<dd><p>A named list where each name corresponds to a server name
and each element is a character vector of variable names from that server.</p></dd>


<dt id="arg-log-n">log_n<a class="anchor" aria-label="anchor" href="#arg-log-n"></a></dt>
<dd><p>Integer. CKKS ring dimension parameter (12, 13, or 14).
Controls the number of slots: N/2 = 2^(logN-1).
Default is 12 (2048 slots, fast). Use 13 or 14 for larger datasets.</p></dd>


<dt id="arg-log-scale">log_scale<a class="anchor" aria-label="anchor" href="#arg-log-scale"></a></dt>
<dd><p>Integer. CKKS scale parameter controlling precision.
Default is 40 (approximately 12 decimal digits of precision).</p></dd>


<dt id="arg-datasources">datasources<a class="anchor" aria-label="anchor" href="#arg-datasources"></a></dt>
<dd><p>DataSHIELD connection object or list of connections.
If NULL, uses all available connections.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>A list with class <code>"ds.cor"</code> containing:</p><ul><li><p><code>correlation</code>: The full correlation matrix (p x p)</p></li>
<li><p><code>var_names</code>: Variable names in order</p></li>
<li><p><code>n_obs</code>: Number of observations</p></li>
<li><p><code>method</code>: <code>"MHE-CKKS-Threshold"</code> indicating the method used</p></li>
<li><p><code>servers</code>: Names of servers involved</p></li>
<li><p><code>local_correlations</code>: List of within-server correlation matrices</p></li>
<li><p><code>cross_correlations</code>: List of cross-server correlation matrices</p></li>
<li><p><code>mhe_params</code>: List with <code>log_n</code> and <code>log_scale</code> used</p></li>
</ul></div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>

<div class="section">
<h3 id="threshold-mhe-protocol-phases-">Threshold MHE Protocol (6 phases)<a class="anchor" aria-label="anchor" href="#threshold-mhe-protocol-phases-"></a></h3>
<p>This function implements a full multiparty homomorphic encryption protocol
with threshold decryption:</p>
<ol><li><p><strong>Key Generation</strong>: Each server generates its own secret key share
and a public key share. Party 0 also generates the Common Reference
Polynomial (CRP) shared by all parties.</p></li>
<li><p><strong>Key Combination</strong>: Public key shares are combined into a
Collective Public Key (CPK). Data encrypted under the CPK can only be
decrypted with ALL servers cooperating.</p></li>
<li><p><strong>Encryption</strong>: Each server standardizes its columns (Z-scores)
and encrypts them column-by-column under the CPK.</p></li>
<li><p><strong>Local Correlation</strong>: Within-server correlations are computed in
plaintext (no encryption needed for data that stays on-server).</p></li>
<li><p><strong>Cross-Server Correlation</strong>: For each pair of servers (A, B),
server A receives Enc(Z_B) and computes the element-wise product
Z_A * Enc(Z_B) homomorphically. The result is still encrypted and
requires threshold decryption. Each server produces a partial decryption
share, and the client fuses all shares to recover the inner product.</p></li>
<li><p><strong>Assembly</strong>: The client assembles the full p x p correlation
matrix from local correlations (diagonal blocks) and cross-server
correlations (off-diagonal blocks).</p></li>
</ol></div>

<div class="section">
<h3 id="security-guarantees">Security Guarantees<a class="anchor" aria-label="anchor" href="#security-guarantees"></a></h3>

<dl><dt>Client privacy</dt>
<dd><p>The client (researcher) CANNOT decrypt any individual
data. It only receives partial decryption shares that are useless alone.
Only the final aggregate statistics (correlation coefficients) are revealed
after fusing ALL shares.</p></dd>

<dt>Server privacy</dt>
<dd><p>Each server's raw data never leaves the server. Other
servers only see encrypted columns (opaque ciphertexts).</p></dd>

<dt>Collusion resistance</dt>
<dd><p>Even K-1 colluding servers cannot decrypt
without the K-th server's key share. Full decryption requires cooperation
from ALL K servers.</p></dd>


</dl></div>

    </div>
    <div class="section level2">
    <h2 id="performance-notes">Performance Notes<a class="anchor" aria-label="anchor" href="#performance-notes"></a></h2>


<ul><li><p><code>log_n = 12</code>: Up to 2048 observations, fastest</p></li>
<li><p><code>log_n = 13</code>: Up to 4096 observations</p></li>
<li><p><code>log_n = 14</code>: Up to 8192 observations, slowest</p></li>
<li><p>Precision: approximately 10^-3 to 10^-4 error due to CKKS approximation</p></li>
<li><p>The dominant cost is the threshold decryption loop (Phase 5), which
requires one round-trip per server per cross-correlation element.</p></li>
</ul></div>
    <div class="section level2">
    <h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a></h2>
    <p>Mouchet, C. et al. (2021). "Multiparty Homomorphic Encryption from
Ring-Learning-With-Errors". <em>Proceedings on Privacy Enhancing Technologies (PETS)</em>.</p>
<p>Cheon, J.H. et al. (2017). "Homomorphic Encryption for Arithmetic of
Approximate Numbers". <em>ASIACRYPT 2017</em>.</p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p><code><a href="ds.vertPCA.html">ds.vertPCA</a></code> for PCA analysis built on this function</p></div>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span> <span class="co"># \dontrun{</span></span></span>
<span class="r-in"><span><span class="co"># Connect to Opal/DataSHIELD servers</span></span></span>
<span class="r-in"><span><span class="va">connections</span> <span class="op">&lt;-</span> <span class="fu">DSI</span><span class="fu">::</span><span class="fu"><a href="https://datashield.github.io/DSI/reference/datashield.login.html" class="external-link">datashield.login</a></span><span class="op">(</span><span class="va">builder</span><span class="op">$</span><span class="fu">build</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Align records across servers</span></span></span>
<span class="r-in"><span><span class="va">ref_hashes</span> <span class="op">&lt;-</span> <span class="fu"><a href="ds.hashId.html">ds.hashId</a></span><span class="op">(</span><span class="st">"D"</span>, <span class="st">"patient_id"</span>, datasource <span class="op">=</span> <span class="va">connections</span><span class="op">[</span><span class="st">"server1"</span><span class="op">]</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="ds.alignRecords.html">ds.alignRecords</a></span><span class="op">(</span><span class="st">"D"</span>, <span class="st">"patient_id"</span>, <span class="va">ref_hashes</span><span class="op">$</span><span class="va">hashes</span>,</span></span>
<span class="r-in"><span>                newobj <span class="op">=</span> <span class="st">"D_aligned"</span>, datasources <span class="op">=</span> <span class="va">connections</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Define which variables are on which server</span></span></span>
<span class="r-in"><span><span class="va">vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  hospital_A <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"age"</span>, <span class="st">"bmi"</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  hospital_B <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"glucose"</span>, <span class="st">"systolic_bp"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Compute privacy-preserving correlation</span></span></span>
<span class="r-in"><span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">ds.vertCor</span><span class="op">(</span><span class="st">"D_aligned"</span>, <span class="va">vars</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span> <span class="co"># }</span></span></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

<div class="pkgdown-footer-right">

</div>

    </footer></div>





  </body></html>

